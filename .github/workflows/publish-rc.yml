name: Publish RC

on:
  push:
    branches: [main]

jobs:
  rc-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    environment:
      name: testpypi
      url: https://test.pypi.org/p/triagent

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install python-semantic-release build

      - name: Get next version and create RC
        id: version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get what the next version would be
          NEXT_VERSION=$(semantic-release version --print 2>/dev/null || echo "")
          if [ -z "$NEXT_VERSION" ]; then
            echo "No releasable commits"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Count existing RCs for this version
          RC_COUNT=$(git tag -l "v${NEXT_VERSION}-rc.*" | wc -l)
          RC_NUM=$((RC_COUNT + 1))
          RC_VERSION="${NEXT_VERSION}-rc.${RC_NUM}"

          echo "version=$RC_VERSION" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

          # Update pyproject.toml with RC version
          sed -i "s/^version = .*/version = \"$RC_VERSION\"/" pyproject.toml

      - name: Build package
        if: steps.version.outputs.skip != 'true'
        run: python -m build

      - name: Create git tag
        if: steps.version.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Publish to TestPyPI
        if: steps.version.outputs.skip != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

      - name: Create GitHub Pre-release
        if: steps.version.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            --title "v${{ steps.version.outputs.version }}" \
            --prerelease \
            --generate-notes \
            dist/*
