name: Cross-Platform CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

jobs:
  test-matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install UV
        run: pip install uv

      - name: Install dependencies
        run: uv pip install --system -e ".[dev]"

      - name: Verify triagent installation
        run: |
          python --version
          triagent --version

      - name: Run linting
        run: ruff check src/

      - name: Run type checking
        run: mypy src/triagent --ignore-missing-imports
        continue-on-error: true

      - name: Run unit tests
        run: pytest tests/unit/ -v --cov=triagent --cov-report=xml
        continue-on-error: true

      - name: Run CLI smoke tests
        run: |
          triagent --help
          triagent --version

  test-docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t triagent-test .

      - name: Verify triagent in container
        run: docker run --rm triagent-test triagent --version

      - name: Run unit tests in container
        run: docker run --rm triagent-test pytest tests/unit/ -v
        continue-on-error: true

  test-azure-cli-install:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        # Windows skipped due to longer install time

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install triagent
        run: |
          pip install uv
          uv pip install --system -e ".[dev]"

      - name: Test Azure CLI auto-install function
        run: |
          python -c "
          from triagent.mcp.setup import install_azure_cli, check_azure_cli_installed
          import platform

          print(f'OS: {platform.system()}')

          # Check if already installed
          installed, version = check_azure_cli_installed()
          if installed:
              print(f'Azure CLI already installed: {version}')
          else:
              print('Azure CLI not installed, testing install_azure_cli()...')
              success, message = install_azure_cli()
              print(f'Result: success={success}, message={message}')

              # Verify
              installed, version = check_azure_cli_installed()
              print(f'Verification: installed={installed}, version={version}')
          "

      - name: Verify Azure CLI
        run: az --version || echo "Azure CLI not available (expected if install requires sudo)"
        continue-on-error: true
