name: Test Windows Installer

on:
  push:
    branches: [main, feature/powershell-installer-v2]
    paths:
      - 'install.ps1'
      - '.github/workflows/test-windows-installer.yml'
      - 'src/triagent/versions.py'
  pull_request:
    branches: [main]
    paths:
      - 'install.ps1'

jobs:
  validate-syntax-pwsh:
    name: Validate PowerShell 7.x Syntax
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate PowerShell 7.x syntax
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)" -ForegroundColor Cyan
          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile(
            "$PWD\install.ps1",
            [ref]$null,
            [ref]$errors
          )
          if ($errors) {
            Write-Host "PowerShell syntax errors found:" -ForegroundColor Red
            foreach ($err in $errors) {
              Write-Host "Line $($err.Extent.StartLineNumber): $($err.Message)" -ForegroundColor Red
              Write-Host "  Code: $($err.Extent.Text)" -ForegroundColor Yellow
            }
            exit 1
          }
          Write-Host "PowerShell 7.x syntax validation passed" -ForegroundColor Green

  validate-syntax-ps51:
    name: Validate PowerShell 5.1 Syntax
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate PowerShell 5.1 syntax
        shell: powershell
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)" -ForegroundColor Cyan
          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile(
            "$PWD\install.ps1",
            [ref]$null,
            [ref]$errors
          )
          if ($errors) {
            Write-Host "PowerShell syntax errors found:" -ForegroundColor Red
            foreach ($err in $errors) {
              Write-Host "Line $($err.Extent.StartLineNumber): $($err.Message)" -ForegroundColor Red
              Write-Host "  Code: $($err.Extent.Text)" -ForegroundColor Yellow
            }
            exit 1
          }
          Write-Host "PowerShell 5.1 syntax validation passed" -ForegroundColor Green

  test-admin-check:
    name: Test Admin Check
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test admin check (should fail without admin)
        shell: pwsh
        run: |
          # GitHub Actions runners don't run as Administrator
          # This should trigger the admin check and exit gracefully
          $output = .\install.ps1 -NonInteractive 2>&1 | Out-String
          if ($output -match "Administrator") {
            Write-Host "Admin check is working correctly" -ForegroundColor Green
            Write-Host "Output contained expected admin message"
          } else {
            Write-Host "Warning: Admin check may not be working as expected" -ForegroundColor Yellow
            Write-Host "Output: $output"
          }
        continue-on-error: true

  test-git-bash-detection:
    name: Test Git Bash Detection
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test Git Bash path detection logic
        shell: pwsh
        run: |
          # windows-latest has Git pre-installed
          # Test the same detection logic used in install.ps1

          Write-Host "Testing Git Bash detection methods..." -ForegroundColor Cyan

          # Method 1: Check if git is in PATH
          $gitCmd = Get-Command git -ErrorAction SilentlyContinue
          if ($gitCmd) {
            $gitDir = Split-Path (Split-Path $gitCmd.Source -Parent) -Parent
            $bashPath = Join-Path $gitDir "bin\bash.exe"
            Write-Host "Method 1 (PATH): Git found at $($gitCmd.Source)"
            Write-Host "  Expected bash.exe at: $bashPath"
            if (Test-Path $bashPath) {
              Write-Host "  Result: FOUND" -ForegroundColor Green
            } else {
              Write-Host "  Result: NOT FOUND at expected location" -ForegroundColor Yellow
            }
          } else {
            Write-Host "Method 1 (PATH): Git not in PATH" -ForegroundColor Yellow
          }

          # Method 2: Check registry
          $regPaths = @(
            "HKLM:\SOFTWARE\GitForWindows",
            "HKCU:\SOFTWARE\GitForWindows",
            "HKLM:\SOFTWARE\WOW6432Node\GitForWindows"
          )
          foreach ($regPath in $regPaths) {
            try {
              $installPath = (Get-ItemProperty -Path $regPath -ErrorAction SilentlyContinue).InstallPath
              if ($installPath) {
                $bashPath = Join-Path $installPath "bin\bash.exe"
                Write-Host "Method 2 (Registry): Found at $regPath"
                Write-Host "  Install path: $installPath"
                Write-Host "  Expected bash.exe at: $bashPath"
                if (Test-Path $bashPath) {
                  Write-Host "  Result: FOUND" -ForegroundColor Green
                }
              }
            } catch { }
          }

          # Method 3: Common paths
          $programFilesX86 = [Environment]::GetFolderPath('ProgramFilesX86')
          $commonPaths = @(
            "$env:ProgramFiles\Git\bin\bash.exe",
            "$programFilesX86\Git\bin\bash.exe",
            "$env:LOCALAPPDATA\Programs\Git\bin\bash.exe"
          )
          Write-Host "Method 3 (Common paths):"
          foreach ($path in $commonPaths) {
            if (Test-Path $path) {
              Write-Host "  FOUND: $path" -ForegroundColor Green
            }
          }

  verify-versions:
    name: Verify Pinned Versions
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check versions.py has required constants
        shell: pwsh
        run: |
          $content = Get-Content src/triagent/versions.py -Raw

          $required = @(
            "PYTHON_VERSION",
            "AZURE_CLI_VERSION",
            "GIT_FOR_WINDOWS_VERSION"
          )

          $missing = @()
          foreach ($const in $required) {
            if ($content -match $const) {
              Write-Host "Found: $const" -ForegroundColor Green
            } else {
              Write-Host "Missing: $const" -ForegroundColor Red
              $missing += $const
            }
          }

          if ($missing.Count -gt 0) {
            Write-Host ""
            Write-Host "Missing constants in versions.py: $($missing -join ', ')" -ForegroundColor Red
            exit 1
          }

          Write-Host ""
          Write-Host "All required version constants found" -ForegroundColor Green

      - name: Verify install.ps1 versions match versions.py
        shell: pwsh
        run: |
          # Extract versions from versions.py
          $versionsContent = Get-Content src/triagent/versions.py -Raw

          $pyMatch = [regex]::Match($versionsContent, 'PYTHON_VERSION\s*=\s*"([^"]+)"')
          $azMatch = [regex]::Match($versionsContent, 'AZURE_CLI_VERSION\s*=\s*"([^"]+)"')
          $gitMatch = [regex]::Match($versionsContent, 'GIT_FOR_WINDOWS_VERSION\s*=\s*"([^"]+)"')

          $pyVersion = $pyMatch.Groups[1].Value
          $azVersion = $azMatch.Groups[1].Value
          $gitVersion = $gitMatch.Groups[1].Value

          Write-Host "Versions from versions.py:" -ForegroundColor Cyan
          Write-Host "  Python: $pyVersion"
          Write-Host "  Azure CLI: $azVersion"
          Write-Host "  Git: $gitVersion"

          # Extract versions from install.ps1
          $installContent = Get-Content install.ps1 -Raw

          $ps1PyMatch = [regex]::Match($installContent, '\$script:PythonVersion\s*=\s*"([^"]+)"')
          $ps1AzMatch = [regex]::Match($installContent, '\$script:AzureCLIVersion\s*=\s*"([^"]+)"')
          $ps1GitMatch = [regex]::Match($installContent, '\$script:GitVersion\s*=\s*"([^"]+)"')

          Write-Host ""
          Write-Host "Versions from install.ps1:" -ForegroundColor Cyan
          Write-Host "  Python: $($ps1PyMatch.Groups[1].Value)"
          Write-Host "  Azure CLI: $($ps1AzMatch.Groups[1].Value)"
          Write-Host "  Git: $($ps1GitMatch.Groups[1].Value)"

          # Compare
          $errors = @()
          if ($ps1PyMatch.Groups[1].Value -ne $pyVersion) {
            $errors += "Python version mismatch"
          }
          if ($ps1AzMatch.Groups[1].Value -ne $azVersion) {
            $errors += "Azure CLI version mismatch"
          }
          if ($ps1GitMatch.Groups[1].Value -ne $gitVersion) {
            $errors += "Git version mismatch"
          }

          if ($errors.Count -gt 0) {
            Write-Host ""
            Write-Host "Version mismatches found:" -ForegroundColor Red
            $errors | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
            exit 1
          }

          Write-Host ""
          Write-Host "All versions match between versions.py and install.ps1" -ForegroundColor Green

  test-azure-cli-detection:
    name: Test Azure CLI Detection
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test Azure CLI is pre-installed
        shell: pwsh
        run: |
          # windows-latest has Azure CLI pre-installed
          Write-Host "Testing Azure CLI detection..." -ForegroundColor Cyan

          # Test az command exists
          $azCmd = Get-Command az -ErrorAction SilentlyContinue
          if ($azCmd) {
            Write-Host "Azure CLI found at: $($azCmd.Source)" -ForegroundColor Green

            # Get version using same regex as install.ps1
            $output = & az --version 2>&1
            if ($output[0] -match "azure-cli\s+(\d+\.\d+\.\d+)") {
              Write-Host "Azure CLI Version: $($Matches[1])" -ForegroundColor Green
            } else {
              Write-Host "Could not parse version from output" -ForegroundColor Yellow
              Write-Host "Output: $($output[0])"
            }
          } else {
            Write-Host "Azure CLI not found in PATH" -ForegroundColor Red
            exit 1
          }

  test-azure-cli-version-check:
    name: Test Azure CLI Version Comparison
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test version comparison logic
        shell: pwsh
        run: |
          # Test the version comparison function (same logic as install.ps1)
          function Test-AzureCLIVersionOutdated {
            param([string]$CurrentVersion, [string]$RequiredVersion)
            try {
              $current = [version]$CurrentVersion
              $required = [version]$RequiredVersion
              return $current -lt $required
            } catch {
              return $false
            }
          }

          # Test cases
          $tests = @(
            @{ Current = "2.66.0"; Required = "2.67.0"; Expected = $true; Desc = "Older version" },
            @{ Current = "2.67.0"; Required = "2.67.0"; Expected = $false; Desc = "Same version" },
            @{ Current = "2.70.0"; Required = "2.67.0"; Expected = $false; Desc = "Newer version" },
            @{ Current = "2.67.1"; Required = "2.67.0"; Expected = $false; Desc = "Patch newer" },
            @{ Current = "3.0.0"; Required = "2.67.0"; Expected = $false; Desc = "Major newer" }
          )

          Write-Host "Testing version comparison logic..." -ForegroundColor Cyan
          $failed = 0
          foreach ($test in $tests) {
            $result = Test-AzureCLIVersionOutdated -CurrentVersion $test.Current -RequiredVersion $test.Required
            if ($result -eq $test.Expected) {
              Write-Host "PASS: $($test.Desc) ($($test.Current) vs $($test.Required))" -ForegroundColor Green
            } else {
              Write-Host "FAIL: $($test.Desc) - Expected $($test.Expected), Got $result" -ForegroundColor Red
              $failed++
            }
          }

          if ($failed -gt 0) {
            Write-Host ""
            Write-Host "$failed test(s) failed" -ForegroundColor Red
            exit 1
          }
          Write-Host ""
          Write-Host "All version comparison tests passed" -ForegroundColor Green

  test-azure-cli-registry:
    name: Test Azure CLI Registry Detection
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test Azure CLI registry lookup
        shell: pwsh
        run: |
          Write-Host "Testing Azure CLI registry detection..." -ForegroundColor Cyan

          # Same logic as Uninstall-AzureCLI detection in install.ps1
          $uninstallKey = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" -ErrorAction SilentlyContinue |
            Where-Object { $_.DisplayName -like "*Azure CLI*" }

          if ($uninstallKey) {
            Write-Host "Azure CLI found in registry:" -ForegroundColor Green
            Write-Host "  DisplayName: $($uninstallKey.DisplayName)"
            Write-Host "  Version: $($uninstallKey.DisplayVersion)"
            Write-Host "  UninstallString: $($uninstallKey.UninstallString)"
            Write-Host "  ProductCode: $($uninstallKey.PSChildName)"

            # Verify uninstall string contains msiexec (as expected by install.ps1)
            if ($uninstallKey.UninstallString -match "msiexec") {
              Write-Host "  MSI uninstall: Supported" -ForegroundColor Green
            } else {
              Write-Host "  MSI uninstall: Not detected (different install method)" -ForegroundColor Yellow
            }
          } else {
            Write-Host "Azure CLI not found in registry" -ForegroundColor Yellow
            Write-Host "Note: This may indicate a different installation method (winget, chocolatey, etc.)"
          }

  test-azure-cli-upgrade-logic:
    name: Test Azure CLI Upgrade Logic
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Test upgrade decision logic
        shell: pwsh
        run: |
          # Read required version from versions.py (same as install.ps1)
          $versionsContent = Get-Content src/triagent/versions.py -Raw
          $azMatch = [regex]::Match($versionsContent, 'AZURE_CLI_VERSION\s*=\s*"([^"]+)"')
          $requiredVersion = $azMatch.Groups[1].Value

          Write-Host "Testing upgrade decision logic..." -ForegroundColor Cyan
          Write-Host "Required Version (from versions.py): $requiredVersion" -ForegroundColor Cyan

          # Get current installed version
          $output = & az --version 2>&1
          $currentVersion = "unknown"
          if ($output[0] -match "azure-cli\s+(\d+\.\d+\.\d+)") {
            $currentVersion = $Matches[1]
          }

          Write-Host "Current Version (installed): $currentVersion" -ForegroundColor Cyan

          # Check if upgrade needed (same logic as install.ps1)
          try {
            $current = [version]$currentVersion
            $required = [version]$requiredVersion

            if ($current -lt $required) {
              Write-Host ""
              Write-Host "Decision: UPGRADE NEEDED" -ForegroundColor Yellow
              Write-Host "  Reason: Current version ($currentVersion) < Required ($requiredVersion)"
            } else {
              Write-Host ""
              Write-Host "Decision: NO UPGRADE NEEDED" -ForegroundColor Green
              Write-Host "  Reason: Current version ($currentVersion) >= Required ($requiredVersion)"
            }
          } catch {
            Write-Host ""
            Write-Host "Decision: COULD NOT DETERMINE" -ForegroundColor Red
            Write-Host "  Error: $($_.Exception.Message)"
            exit 1
          }

  test-documentation:
    name: Verify Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check documentation exists
        run: |
          if [ -f "docs/windows-installation.md" ]; then
            echo "Windows installation documentation found"
          else
            echo "Missing: docs/windows-installation.md"
            exit 1
          fi

      - name: Check README references docs
        run: |
          if grep -q "windows-installation.md" README.md; then
            echo "README references windows installation docs"
          else
            echo "Warning: README should reference docs/windows-installation.md"
          fi
